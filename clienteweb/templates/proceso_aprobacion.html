{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proceso de Aprobación</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'clienteweb/css/estilo.css' %}">
    <link rel="stylesheet" href="{% static 'clienteweb/css/estilo_aprobacion.css' %}">

</head>
<body class="dashboard-page">

    <div class="main-wrapper">
        
        <nav id="sidebar">
            <div class="sidebar-header">
                <h4>Mi Menú</h4>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#gestionSubmenu" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="gestionSubmenu">
                     <i class="bi bi-cart4"></i> Gestión
                    </a>
                    <ul class="collapse list-unstyled submenu" id="gestionSubmenu">
                        <li><a class="nav-link" href="{% url 'proceso_aprobacion' %}">Proceso de Aprobación</a></li>
                        
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-pie-chart-fill"></i> Finanzas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-person-rolodex"></i> CRM</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-lightbulb-fill"></i> Oportunidades</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-cash-coin"></i> Ventas - Clientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#comprasSubmenu" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="comprasSubmenu">
                        <i class="bi bi-cart4"></i> Compras - Proveedores
                    </a>
                    <ul class="collapse list-unstyled submenu" id="comprasSubmenu">
                        <li><a class="nav-link" href="#">Solicitud de Compras</a></li>
                        <li><a class="nav-link" href="#">Pedido</a></li>
                        <li><a class="nav-link" href="#">Entrada de Proveedor</a></li>
                        <li><a class="nav-link" href="#">Factura de Proveedor</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-people-fill"></i> Socios de Negocios</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-bank"></i> Gestión de Bancos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-box-seam-fill"></i> Inventario</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-cpu-fill"></i> Recursos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-gear-wide-connected"></i> Producción</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-clipboard-data-fill"></i> MRP</a>
                <li class="nav-item">
                    <a class="nav-link" href="#mantenimientoSubmenu" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="mantenimientoSubmenu">
                        <i class="bi bi-tools"></i> Mantenimiento
                    </a>                    
                    <ul class="collapse list-unstyled submenu" id="mantenimientoSubmenu">
                        <li>
                            <a class="nav-link" href="{% url 'equipos' %}"><i class="bi bi-truck"></i> Equipos</a>
                        </li>
                        <li>
                            <a class="nav-link" href="#"><i class="bi bi-card-checklist"></i> Planes de Mantenimiento</a>
                        </li>
                        <li>
                            <a class="nav-link" href="#"><i class="bi bi-speedometer2"></i> Lecturas</a>
                        </li>
                        <li>
                            <a class="nav-link" href="#omSubmenu" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="omSubmenu"
                            ><i class="bi bi-journal-check"></i> Ordenes de Mantenimiento</a>
                            <ul class="collapse list-unstyled submenu" id="omSubmenu">
                                <li>
                                    <a class="nav-link" href="#"><i class="bi bi-pencil-square"></i> Orden de Mantenimiento</a>
                                </li>
                                <li>
                                    <a class="nav-link" href="{% url 'orden_mantenimiento' %}"><i class="bi bi-pencil-square"></i> Administrador de OM</a>
                                </li>
                                <li>
                                    <a class="nav-link" href="{% url 'tareas' %}"><i class="bi bi-pencil-square"></i> Totem</a>
                                </li>
                            </ul>
                        </li>                        
                        <li>
                            <a class="nav-link" href="#tareasSubmenu" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="tareasSubmenu">
                                <i class="bi bi-list-task"></i> Tareas
                            </a>
                            
                            <ul class="collapse list-unstyled submenu" id="tareasSubmenu">
                                <li>
                                    <a class="nav-link" href="#"><i class="bi bi-pencil-square"></i> Registro de Tareas</a>
                                </li>
                                <li>
                                    <a class="nav-link" href="#"><i class="bi bi-stack"></i> Registro de Tareas Masivo</a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a class="nav-link" href="#"><i class="bi bi-envelope-paper"></i> Solicitudes</a>
                        </li>
                        <li>
                            <a class="nav-link" href="#"><i class="bi bi-wrench"></i> Herramientas</a>
                        </li>
                         <li>
                            <a class="nav-link" href="#"><i class="bi bi-box-seam"></i> Materiales</a>
                        </li>
                         <li>
                            <a class="nav-link" href="#"><i class="bi bi-clipboard-data"></i> Informes</a>
                        </li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-headset"></i> Servicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-person-badge-fill"></i> Recursos Humanos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-file-earmark-bar-graph-fill"></i> Informes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"><i class="bi bi-file-earmark-excel-fill"></i> Excel Report...</a>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <button type="button" id="sidebarCollapse" class="btn">
    <i class="bi bi-list"></i>
</button>

<h2 class="mt-3 mb-4">Documentos Pendiente de Aprobación</h2>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form>
            <div class="row g-3 align-items-end">
                <div class="col-md-4 col-lg-3">
                    <label for="buscar" class="form-label">Buscar</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="buscar">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="modelo" class="form-label">Modelo</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="modelo">
                        <span class="input-group-text"><i class="bi bi-box"></i></span>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="creador" class="form-label">Creador</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="creador">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="fechaSolicitud" class="form-label">Fecha de solicitud</label>
                    <input type="date" class="form-control" id="fechaSolicitud">
                </div>

                <div class="col-md-4 col-lg-3">
                    <label for="Estado" class="form-label">Estado</label>
                    <select id="Estado" class="form-select">
                        <option value="Pendiente" {% if estado_actual == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                        <option value="Aprobado" {% if estado_actual == 'Aprobado' %}selected{% endif %}>Aprobado</option>
                        <option value="Rechazado" {% if estado_actual == 'Rechazado' %}selected{% endif %}>Rechazado</option>
                    </select>
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="autorizador" class="form-label">Autorizador</label>
                     <div class="input-group">
                        <input type="text" class="form-control" id="autorizador">
                        <span class="input-group-text"><i class="bi bi-person-check"></i></span>
                    </div>
                </div>
                <div class="col-md-4 col-lg-3">
                    <button type="submit" id="btnAdaptarFiltros" class="btn btn-primary w-100">Adaptar filtros</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap">
        <div class="me-3">
            <h5 class="mb-0 d-inline-block">Decisiones de aprobación <span id="aprobacionCount">(3 / 4)</span></h5>
            
        </div>
        <div class="d-flex align-items-center mt-2 mt-md-0">
            <div class="btn-group btn-group-sm me-3" role="group" aria-label="Acciones de documento">
                <button type="button" class="btn btn-success fw-bold">
                    <i class="bi bi-check-circle me-1"></i> Aprobar </button>
                <button type="button" class="btn btn-danger fw-bold">
                    <i class="bi bi-x-circle me-1"></i> Rechazar </button>
                 <button type="button" class="btn btn-warning">
                    <i class="bi bi-slash-circle me-1"></i> Cancelar </button>
            </div>
        </div>
    </div>
        <div class="card-body p-0">
    <div class="table-responsive">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col" style="width: 20px;"></th> 
                    <th scope="col" class="text-center"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th>
                    <th scope="col">Empresa</th>
                    <th scope="col">Nro Borrador</th>
                    <th scope="col">Tipo de Documento</th>
                    <th scope="col">Creador</th>
                    <th scope="col">Comentarios</th>
                    <th scope="col" class="text-end">Importe</th>
                    <th scope="col" class="d-none">Etapa</th> <th scope="col">Estado Documento</th>
                </tr>
            </thead>
<tbody>
    {% if documentos %}
        {% for doc in documentos %}
        <tr>
            <td>
                <button class="btn btn-sm btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#detalle-{{ forloop.counter }}" aria-expanded="false" aria-controls="detalle-{{ forloop.counter }}">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </td>
            <td class="text-center"><input class="form-check-input row-checkbox" type="checkbox"></td>
            
            <td><span class="fw-bold">{{ doc.Empresa }}</span></td>
            <td>{{ doc.Ndeborrador }}</td>
            <td>{{ doc.TipodeDocumento }}</td>
            <td>{{ doc.U_NAME }}</td>
            <td><small class="text-muted">{{ doc.Comentarios|default:"Sin comentarios" }}</small></td>
            <td class="text-end">$ {{ doc.ImporteTotal }}</td>
            <td class="d-none">{{ doc.Etapa }}</td>
            <td><span class="badge bg-warning text-dark">{{ doc.EstadodeDocumento }}</span></td>
        </tr>
        
        <tr class="collapse" id="detalle-{{ forloop.counter }}">
            <td colspan="10"> 
                <div class="p-3">
                    <h6 class="mb-2 fw-bold">Historial de Aprobación</h6>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Etapa</th>
                                <th scope="col">Autorizado por</th>
                                <th scope="col">Estado Etapa</th>
                                <th scope="col">Fecha de respuesta</th>
                                <th scope="col">Hora de respuesta</th>
                                <th scope="col">Comentarios</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item_historial in doc.Historial %}
                            <tr>
                                <td><i class="bi bi-arrow-right-short"></i> {{ item_historial.Etapa }}</td>
                                <td>{{ item_historial.Aprobador }}</td>
                                <td><span class="
                                                {% if item_historial.EstadodeEtapa == 'Autorizado' %}status-autorizado
                                                {% elif item_historial.EstadodeEtapa == 'Pendiente' %}status-pendiente
                                                {% elif item_historial.EstadodeEtapa == 'Rechazado' %}status-rechazado
                                                {% endif %}
                                                ">{{ item_historial.EstadodeEtapa }}</span></td>
                                <td>{{ item_historial.FechadeRepuesta }}</td>
                                <td>{{ item_historial.TiempodeRespuesta }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No hay historial de aprobación para este documento.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        {% endfor %}
    {% else %}
        <tr>
            <td colspan="10" class="text-center p-4">
                No se encontraron documentos pendientes de aprobación o hubo un error al conectar con SAP.
            </td>
        </tr>
    {% endif %}
</tbody>
        </table>
    </div>
</div> 
           
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'clienteweb/js/proceso_autorizacion.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var sidebarCollapse = document.getElementById('sidebarCollapse');
            var sidebar = document.getElementById('sidebar');
            sidebarCollapse.addEventListener('click', function () {
                sidebar.classList.toggle('toggled');
            });
        });
    </script>
    
</body>
</html>